<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Senedd Calculator + Coalition Builder</title>
<style>
  body { font-family: Inter, system-ui, sans-serif; background: #fff; color: #0f172a; margin: 0; padding: 0 24px 24px 24px; }
  table { width: 100%; border-collapse: collapse; margin-top: 12px; }
  th, td { padding: 4px 6px; border: 1px solid #e2e8f0; }
  th { background: #f1f5f9; font-weight: 600; text-align: left; }
  td.party-column { font-weight: bold; position: relative; padding-left: 14px; color: black; }
  td.party-column::before { content: ""; position: absolute; left: 0; top: 0; width: 8px; height: 100%; border-radius: 2px 0 0 2px; background-color: var(--party-color); }
  td.ge2024-column { font-style: italic; color: #999999; }
  td.seats-column { font-weight: bold; text-align: center; }
  .input-wrapper { display: flex; align-items: center; }
  .input-wrapper input { width: 50px; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: left; margin-right: 4px; transition: border-color 0.3s ease; }
  .percent-sign { font-size: 14px; }
  .button-container { display: flex; gap: 8px; margin-top: 14px; }
  button#calculate { background: #008500; color: #fff; border: none; border-radius: 6px; padding: 8px 14px; cursor: pointer; transition: background 0.3s ease; flex: 0 0 80%; }
  button#reset { background: #008500; color: #fff; border: none; border-radius: 6px; padding: 8px 14px; cursor: pointer; transition: background 0.3s ease; flex: 0 0 20%; }
  tfoot td { font-weight: bold; text-align: center; background: #f1f5f9; }
  tfoot td:first-child { text-align: left; padding-left: 14px; }
  input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
  input[type=number] { -moz-appearance: textfield; }

  #coalition-builder { margin-top: 48px; }
  .header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  h3 { margin: 0; }
  .legend { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-bottom: 15px; }
  .legend-item { display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;
    border: 1px solid #ccc; border-radius: 8px; padding: 6px 10px; background: #f3f3f3; transition: all 0.25s ease; opacity: 0.6; font-weight: normal; }
  .legend-item:hover { transform: translateY(-1px); }
  .legend-item.active { opacity: 1; background: #ffffff; border-color: #999; box-shadow: 0 1px 3px rgba(0,0,0,0.15); font-weight: bold; }
  .legend-box { width: 20px; height: 20px; border-radius: 4px; }
  .bar-container { position: relative; height: 117px; background: #f0f0f0; border-radius: 10px; overflow: hidden; margin-bottom: 12px; width: 100%; }
  .coalition-overlay { position: absolute; top: 0; left: 0; height: 100%; width: 0%; border-top-left-radius: 10px; border-bottom-left-radius: 10px; border-top-right-radius: 0; border-bottom-right-radius: 0; display: flex; overflow: hidden; transition: width 1s ease; }
  .segment { height: 100%; flex-shrink: 0; border-radius: 0; }
  .majority-line { position: absolute; top: 0; bottom: 0; width: 2px;
    background: repeating-linear-gradient(to bottom,#333,#333 5px,transparent 5px,transparent 10px);
    left: 50%; }
  .counter { font-size: 22px; font-weight: bold; text-align: center; margin-bottom: 8px; }
  .note { font-size: 13px; color: #555; text-align: center; }
</style>
</head>
<body>

<table>
  <thead>
    <tr>
      <th>Party</th>
      <th>2021</th>
      <th>Votes (%)</th>
      <th>Seats</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
  <tfoot>
    <tr>
      <td>Totals</td>
      <td></td>
      <td id="total-votes">0.0%</td>
      <td id="total-seats">0</td>
    </tr>
  </tfoot>
</table>

<div class="button-container">
  <button id="calculate">Calculate</button>
  <button id="reset">Reset</button>
</div>

<div id="coalition-builder">
  <div class="header-container">
    <h3>Senedd Coalition Builder (User Generated)</h3>
  </div>

  <div class="legend" id="legend"></div>

  <div class="bar-container" id="bar">
    <div class="coalition-overlay" id="coalition-overlay"></div>
    <div class="majority-line" title="Majority (49 seats)"></div>
  </div>

  <div class="counter" id="counter">0 / 96</div>
  <div class="note">Majority = 49 seats</div>
</div>

<script>
const BASELINE = {"baseline_national": {"PiS": 0.175, "KO": 0.155, "PL50": 0.13, "PSL": 0.12, "Lewica": 0.11, "AWA": 0.0, "Razem": 0.1, "Konf": 0.09, "OTH": 0.04, "KKP": 0.08},
 "constituencies": [{"name": "1 – Legnica", "PiS": 0.172033898, "KO": 0.170550489, "PL50": 0.097048611, "PSL": 0.089583333, "Lewica": 0.117635447, "AWA": 0.0, "Razem": 0.097844399, "Konf": 0.079125, "OTH": 0.050842105, "KKP": 0.070333333},                    
 {"name": "2 – Wałbrzych", "PiS": 0.164816384, "KO": 0.187666124, "PL50": 0.109506944, "PSL": 0.101083333, "Lewica": 0.102792331, "AWA": 0.0, "Razem": 0.085574741, "Konf": 0.07525, "OTH": 0.035473684, "KKP": 0.066888889},                    
{"name": "3 – Wrocław", "PiS": 0.131793785, "KO": 0.186504886, "PL50": 0.124041667, "PSL": 0.1145, "Lewica": 0.146731136, "AWA": 0.0, "Razem": 0.151524905, "Konf": 0.08725, "OTH": 0.045578947, "KKP": 0.077555556}, 
{"name": "4 – Bydgoszcz", "PiS": 0.150529661, "KO": 0.176760586, "PL50": 0.135958333, "PSL": 0.1255, "Lewica": 0.127634971, "AWA": 0.0, "Razem": 0.105562597, "Konf": 0.08025, "OTH": 0.033052632, "KKP": 0.071333333}, 
{"name": "5 – Toruń", "PiS": 0.168375706, "KO": 0.149042345, "PL50": 0.141555556, "PSL": 0.130666667, "Lewica": 0.139063904, "AWA": 0.0, "Razem": 0.113266393, "Konf": 0.079625, "OTH": 0.032736842, "KKP": 0.070777778}, 
{"name": "6 – Lublin", "PiS": 0.224830508, "KO": 0.102592834, "PL50": 0.143270833, "PSL": 0.13225, "Lewica": 0.075185868, "AWA": 0.0, "Razem": 0.078668228, "Konf": 0.10475, "OTH": 0.044736842, "KKP": 0.093111111}, 
{"name": "7 – Chełm", "PiS": 0.250882768, "KO": 0.087850163, "PL50": 0.117722222, "PSL": 0.108666667, "Lewica": 0.071171162, "AWA": 0.0, "Razem": 0.06308123, "Konf": 0.097375, "OTH": 0.056736842, "KKP": 0.086555556}, 
{"name": "8 – Zielona Góra", "PiS": 0.137231638, "KO": 0.190493485, "PL50": 0.136048611, "PSL": 0.125583333, "Lewica": 0.115543373, "AWA": 0.0, "Razem": 0.098864553, "Konf": 0.081375, "OTH": 0.038421053, "KKP": 0.072333333}, 
{"name": "9 – Łódź", "PiS": 0.132584746, "KO": 0.207356678, "PL50": 0.107340278, "PSL": 0.099083333, "Lewica": 0.159214017, "AWA": 0.0, "Razem": 0.140778706, "Konf": 0.069625, "OTH": 0.025578947, "KKP": 0.061888889}, 
{"name": "10 – Piotrków Trybunalski", "PiS": 0.230367232, "KO": 0.109509772, "PL50": 0.123951389, "PSL": 0.114416667, "Lewica": 0.084585458, "AWA": 0.0, "Razem": 0.076190152, "Konf": 0.09525, "OTH": 0.041894737, "KKP": 0.084666667},                     
{"name": "11 – Sieradz", "PiS": 0.204957627, "KO": 0.130714984, "PL50": 0.130902778, "PSL": 0.120833333, "Lewica": 0.102837047, "AWA": 0.0, "Razem": 0.088003758, "Konf": 0.08525, "OTH": 0.037789474, "KKP": 0.075777778}, 
{"name": "12 – Kraków I", "PiS": 0.211878531, "KO": 0.122384365, "PL50": 0.135145833, "PSL": 0.12475, "Lewica": 0.078725841, "AWA": 0.0, "Razem": 0.079185256, "Konf": 0.0985, "OTH": 0.042105263, "KKP": 0.087555556}, 
{"name": "13 – Kraków II", "PiS": 0.151666667, "KO": 0.155151466, "PL50": 0.152208333, "PSL": 0.1405, "Lewica": 0.141819683, "AWA": 0.0, "Razem": 0.159393345, "Konf": 0.096375, "OTH": 0.031368421, "KKP": 0.085666667}, 
{"name": "14 – Nowy Sącz", "PiS": 0.265614407, "KO": 0.081286645, "PL50": 0.104541667, "PSL": 0.0965, "Lewica": 0.041877269, "AWA": 0.0, "Razem": 0.049533629, "Konf": 0.109125, "OTH": 0.070210526, "KKP": 0.097}, 
{"name": "15 – Tarnów", "PiS": 0.240600282, "KO": 0.085931596, "PL50": 0.168277778, "PSL": 0.155333333, "Lewica": 0.055187991, "AWA": 0.0, "Razem": 0.065275242, "Konf": 0.099875, "OTH": 0.038736842, "KKP": 0.088777778}, 
{"name": "16 – Płock", "PiS": 0.21805791, "KO": 0.113094463, "PL50": 0.154104167, "PSL": 0.14225, "Lewica": 0.086038763, "AWA": 0.0, "Razem": 0.074370255, "Konf": 0.0815, "OTH": 0.035578947, "KKP": 0.072444444}, 
{"name": "17 – Radom", "PiS": 0.240649718, "KO": 0.105824104, "PL50": 0.126208333, "PSL": 0.1165, "Lewica": 0.075317986, "AWA": 0.0, "Razem": 0.073814891, "Konf": 0.091375, "OTH": 0.039368421, "KKP": 0.081222222}, 
{"name": "18 – Siedlce", "PiS": 0.240353107, "KO": 0.094464169, "PL50": 0.140020833, "PSL": 0.12925, "Lewica": 0.065091144, "AWA": 0.0, "Razem": 0.064113314, "Konf": 0.102625, "OTH": 0.043263158, "KKP": 0.091222222}, 
{"name": "19 – Warsaw I", "PiS": 0.099562147, "KO": 0.218262215, "PL50": 0.119618056, "PSL": 0.110416667, "Lewica": 0.180314213, "AWA": 0.0, "Razem": 0.172383327, "Konf": 0.078, "OTH": 0.028315789, "KKP": 0.069333333}, 
{"name": "20 – Warsaw II", "PiS": 0.15690678, "KO": 0.177871336, "PL50": 0.135958333, "PSL": 0.1255, "Lewica": 0.098212987, "AWA": 0.0, "Razem": 0.095142985, "Konf": 0.08825, "OTH": 0.040631579, "KKP": 0.078444444},                    
{"name": "21 – Opole", "PiS": 0.154533898, "KO": 0.169591205, "PL50": 0.115013889, "PSL": 0.106166667, "Lewica": 0.093942105, "AWA": 0.0, "Razem": 0.087394635, "Konf": 0.081125, "OTH": 0.091368421, "KKP": 0.072111111}, 
{"name": "22 – Krosno", "PiS": 0.270409605, "KO": 0.08002443, "PL50": 0.124493056, "PSL": 0.114916667, "Lewica": 0.05743997, "AWA": 0.0, "Razem": 0.054877637, "Konf": 0.10775, "OTH": 0.027052632, "KKP": 0.095777778}, 
{"name": "23 – Rzeszów", "PiS": 0.255084746, "KO": 0.089364821, "PL50": 0.112125, "PSL": 0.1035, "Lewica": 0.062484287, "AWA": 0.0, "Razem": 0.065885816, "Konf": 0.1185, "OTH": 0.041368421, "KKP": 0.105333333}, 
{"name": "24 – Białystok", "PiS": 0.209555085, "KO": 0.105218241, "PL50": 0.170263889, "PSL": 0.157166667, "Lewica": 0.066561293, "AWA": 0.0, "Razem": 0.068427361, "Konf": 0.122375, "OTH": 0.034421053, "KKP": 0.108777778}, 
{"name": "25 – Gdańsk", "PiS": 0.124576271, "KO": 0.210537459, "PL50": 0.132708333, "PSL": 0.1225, "Lewica": 0.127055523, "AWA": 0.0, "Razem": 0.132600423, "Konf": 0.077875, "OTH": 0.029052632, "KKP": 0.069222222}, 
{"name": "26 – Słupsk", "PiS": 0.144548023, "KO": 0.19140228, "PL50": 0.1226875, "PSL": 0.11325, "Lewica": 0.109515962, "AWA": 0.0, "Razem": 0.101822374, "Konf": 0.090125, "OTH": 0.039157895, "KKP": 0.080111111}, 
{"name": "27 – Bielsko-Biała I", "PiS": 0.181475989, "KO": 0.144750814, "PL50": 0.131354167, "PSL": 0.12125, "Lewica": 0.097642427, "AWA": 0.0, "Razem": 0.091910625, "Konf": 0.098, "OTH": 0.047052632, "KKP": 0.087111111}, 
{"name": "28 – Częstochowa", "PiS": 0.179696328, "KO": 0.146972313, "PL50": 0.132888889, "PSL": 0.122666667, "Lewica": 0.116959966, "AWA": 0.0, "Razem": 0.101000901, "Konf": 0.082, "OTH": 0.040315789, "KKP": 0.072888889}, 
{"name": "29 – Katowice I", "PiS": 0.149096045, "KO": 0.182061889, "PL50": 0.120430556, "PSL": 0.111166667, "Lewica": 0.118989226, "AWA": 0.0, "Razem": 0.111628861, "Konf": 0.086875, "OTH": 0.045052632, "KKP": 0.077222222}, 
{"name": "30 – Bielsko-Biała II", "PiS": 0.188149718, "KO": 0.151364821, "PL50": 0.112395833, "PSL": 0.10375, "Lewica": 0.090401541, "AWA": 0.0, "Razem": 0.085871865, "Konf": 0.1, "OTH": 0.049157895, "KKP": 0.088888889},
                    
{"name": "31 – Katowice II", "PiS": 0.09259734756062371, "KO": 0.08131209436196947, "PL50": 0.4265869041983232, "PSL": 0.03356462691417676, "Lewica": 0.028169781031748633, "AWA": 0.0, "Razem": 0.3032708510554234, "Konf": 0.012, "OTH": 0.01749839487773487, "KKP": 0.012}, 
{"name": "32 – Katowice III", "PiS": 0.09259734756062371, "KO": 0.08131209436196947, "PL50": 0.4265869041983232, "PSL": 0.03356462691417676, "Lewica": 0.028169781031748633, "AWA": 0.0, "Razem": 0.3032708510554234, "Konf": 0.012, "OTH": 0.01749839487773487, "KKP": 0.012}, 
{"name": "33 – Kielce", "PiS": 0.09259734756062371, "KO": 0.08131209436196947, "PL50": 0.4265869041983232, "PSL": 0.03356462691417676, "Lewica": 0.028169781031748633, "AWA": 0.0, "Razem": 0.3032708510554234, "Konf": 0.012, "OTH": 0.01749839487773487, "KKP": 0.012}, 
{"name": "34 – Elbląg", "PiS": 0.09259734756062371, "KO": 0.08131209436196947, "PL50": 0.4265869041983232, "PSL": 0.03356462691417676, "Lewica": 0.028169781031748633, "AWA": 0.0, "Razem": 0.3032708510554234, "Konf": 0.012, "OTH": 0.01749839487773487, "KKP": 0.012}, 
{"name": "35 – Olsztyn", "PiS": 0.09259734756062371, "KO": 0.08131209436196947, "PL50": 0.4265869041983232, "PSL": 0.03356462691417676, "Lewica": 0.028169781031748633, "AWA": 0.0, "Razem": 0.3032708510554234, "Konf": 0.012, "OTH": 0.01749839487773487, "KKP": 0.012}, 
{"name": "36 – Kalisz", "PiS": 0.09259734756062371, "KO": 0.08131209436196947, "PL50": 0.4265869041983232, "PSL": 0.03356462691417676, "Lewica": 0.028169781031748633, "AWA": 0.0, "Razem": 0.3032708510554234, "Konf": 0.012, "OTH": 0.01749839487773487, "KKP": 0.012}, 
{"name": "37 – Konin", "PiS": 0.09259734756062371, "KO": 0.08131209436196947, "PL50": 0.4265869041983232, "PSL": 0.03356462691417676, "Lewica": 0.028169781031748633, "AWA": 0.0, "Razem": 0.3032708510554234, "Konf": 0.012, "OTH": 0.01749839487773487, "KKP": 0.012}, 
{"name": "38 – Piła", "PiS": 0.09259734756062371, "KO": 0.08131209436196947, "PL50": 0.4265869041983232, "PSL": 0.03356462691417676, "Lewica": 0.028169781031748633, "AWA": 0.0, "Razem": 0.3032708510554234, "Konf": 0.012, "OTH": 0.01749839487773487, "KKP": 0.012}, 
{"name": "39 – Poznań", "PiS": 0.09259734756062371, "KO": 0.08131209436196947, "PL50": 0.4265869041983232, "PSL": 0.03356462691417676, "Lewica": 0.028169781031748633, "AWA": 0.0, "Razem": 0.3032708510554234, "Konf": 0.012, "OTH": 0.01749839487773487, "KKP": 0.012}, 
{"name": "40 – Koszalin", "PiS": 0.09259734756062371, "KO": 0.08131209436196947, "PL50": 0.4265869041983232, "PSL": 0.03356462691417676, "Lewica": 0.028169781031748633, "AWA": 0.0, "Razem": 0.3032708510554234, "Konf": 0.012, "OTH": 0.01749839487773487, "KKP": 0.012}, 
{"name": "41 – Szczecin", "PiS": 0.09259734756062371, "KO": 0.08131209436196947, "PL50": 0.4265869041983232, "PSL": 0.03356462691417676, "Lewica": 0.028169781031748633, "AWA": 0.0, "Razem": 0.3032708510554234, "Konf": 0.012, "OTH": 0.01749839487773487, "KKP": 0.012}]};

// --- Added constituency seat counts ---
const CONSTITUENCY_SEATS = {
  "1 – Legnica": 12,
  "2 – Wałbrzych": 8,
  "3 – Wrocław": 14,
  "4 – Bydgoszcz": 12,
  "5 – Toruń": 13,
  "6 – Lublin": 15,
  "7 – Chełm": 12,
  "8 – Zielona Góra": 12,
  "9 – Łódź": 10,
  "10 – Piotrków Trybunalski": 9,
  "11 – Sieradz": 12,
  "12 – Kraków I": 8,
  "13 – Kraków II": 14,
  "14 – Nowy Sącz": 10,
  "15 – Tarnów": 9,
  "16 – Płock": 10,
  "17 – Radom": 9,
   "18 – Siedlce": 12,
   "19 – Warsaw I": 20,
   "20 – Warsaw II": 12,
   "21 – Opole": 12,
   "22 – Krosno": 11,
   "23 – Rzeszów": 15,
   "24 – Białystok": 14,
   "25 – Gdańsk": 12,
   "26 – Słupsk": 14,
   "27 – Bielsko-Biała I": 9,
   "28 – Częstochowa": 7,
   "29 – Katowice I": 9,
   "30 – Bielsko-Biała II": 9,
   "31 – Katowice II": 12,
   "32 – Katowice III": 9,
   "33 – Kielce": 16,
   "34 – Elbląg": 8,
   "35 – Olsztyn": 10,
   "36 – Kalisz": 12,
   "37 – Konin": 9,
   "38 – Piła": 9,
   "39 – Poznań": 10,
   "40 – Koszalin": 8,
   "41 – Szczecin": 12
};

const PARTIES = ["PiS", "KO", "PL50", "PSL", "Lewica", "Razem", "Konf", "KKP"];
const PARTY_COLORS = {"PiS":"#e4003b","KO":"#0087dc","PL50":"#005b54","PSL":"#6ab023","Lewica":"#faa61a","Razem":"#23c7df","Konf":"#f76bee","KKP":"#9b59b6"};
const GE2024 = {"PiS":36.2,"KO":25.1,"PL50":20.7,"PSL":4.4,"Lewica":4.3,"Razem":1.1,"Konf":0.0,"KKP":0.0};
const DEFAULTS = {"PiS":29.9,"KO":31.7,"PL50":2.2,"PSL":3.2,"Lewica":6.5,"Razem":3.6,"Konf":14.7,"KKP":6.2};

const parties = PARTIES.map(name => ({ 
  name, 
  color: PARTY_COLORS[name] || "#999", 
  ge2024: GE2024[name], 
  votes: DEFAULTS[name], 
  final: 0 
}));

const totalSeats = 16 * 6;
const calculateBtn = document.getElementById('calculate');
const resetBtn = document.getElementById('reset');

function renderTable(){
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = parties.map((p,i)=>`
    <tr>
      <td class="party-column" style="--party-color: ${p.color}">${p.name}</td>
      <td class="ge2024-column">${p.ge2024.toFixed(1)}%</td>
      <td>
        <div class="input-wrapper">
          <input type="number" id="votes-${i}" value="${p.votes.toFixed(1)}" min="0" max="100" step="0.1">
          <span class="percent-sign">%</span>
        </div>
      </td>
      <td class="seats-column" id="seats-${i}">—</td>
    </tr>
  `).join('');

  const inputs = document.querySelectorAll('.input-wrapper input');
  inputs.forEach((input, index) => {
    input.addEventListener('keydown', (e) => {
      if(e.key === 'Enter') { e.preventDefault(); if(inputs[index+1]) inputs[index+1].focus(); }
    });
    input.addEventListener('focus', () => { input.dataset.previous = input.value; input.value=''; input.style.borderColor='#cbd5e1'; });
    input.addEventListener('blur', () => { 
      if(input.value==='') input.value=input.dataset.previous||'0.0'; 
      if(parseFloat(input.value) > 100) input.value='100';
      input.style.borderColor = '#cbd5e1';
    });
    input.addEventListener('input', () => {
      let val = parseFloat(input.value) || 0;
      if(val>100){ input.value = 100; input.style.borderColor = 'red'; }
      else input.style.borderColor = '#cbd5e1';
      updateVoteTotal();
      calculateBtn.style.background = '#ffa500';
    });
  });
  updateVoteTotal();
}

function updateVoteTotal() {
  let sum = 0;
  parties.forEach((p,i)=>{
    const val = parseFloat(document.getElementById(`votes-${i}`).value)||0;
    sum += val;
  });
  document.getElementById('total-votes').textContent = sum.toFixed(1)+'%';
}

function computeConstituencyShares() {
  const target = {};
  PARTIES.forEach((name, i)=>{ target[name] = (parseFloat(document.getElementById(`votes-${i}`).value)||0)/100; });
  const base = BASELINE.baseline_national;
  const eps = 1e-9;

  return BASELINE.constituencies.map(row => {
    const out = { name: row.name };
    let sum = 0;
    const all = PARTIES.concat(["AWA","OTH"]);
    all.forEach(p => {
      const baseNat = base[p] ?? 0;
      const targetNat = (p in target) ? target[p] : baseNat;
      const ratio = (baseNat > eps) ? (targetNat / baseNat) : (targetNat > 0 ? (targetNat / eps) : 0);
      const val = (row[p] ?? 0) * ratio;
      out[p] = val;
      sum += val;
    });
    if (sum > 0) all.forEach(p => out[p] = out[p] / sum);
    return out;
  });
}

// D'Hondt with national vote tie-breaker (one seat per round)
const TIE_ORDER = ["PiS","KO","PL50","PSL","Lewica","Razem","Konf","KKP","AWA","OTH"];
function dhondtSeats(votes, seats=6, nationalVotes) {
  const alloc = {"PiS":0,"KO":0,"PL50":0,"PSL":0,"Lewica":0,"Razem":0,"Konf":0,"KKP":0,"AWA":0,"OTH":0};
  for (let s=0; s<seats; s++) {
    const quot = TIE_ORDER.map(p => ({ p, q: (votes[p]||0)/(alloc[p]+1) }));
    let best = quot[0];
    for (let i=1; i<quot.length; i++) {
      const x = quot[i];
      if (x.q > best.q || (Math.abs(x.q - best.q) < 1e-12 && (nationalVotes[x.p]||0) > (nationalVotes[best.p]||0))) {
        best = x;
      }
    }
    alloc[best.p] += 1;
  }
  return alloc;
}

function calculate(){
  const nationalVotes = {};
  parties.forEach((p,i)=>{
    p.votes = parseFloat(document.getElementById(`votes-${i}`).value)||0;
    nationalVotes[p.name] = p.votes;
  });

  const perConst = computeConstituencyShares();
  const totals = {"PiS":0,"KO":0,"PL50":0,"PSL":0,"Lewica":0,"Razem":0,"Konf":0,"KKP":0,"AWA":0,"OTH":0};
  perConst.forEach(row => {
    const s = dhondtSeats(row, CONSTITUENCY_SEATS[row.name] || 6, nationalVotes);
    Object.keys(totals).forEach(p => totals[p] += s[p]||0);
  });

  PARTIES.forEach((name,i)=>{
    document.getElementById(`seats-${i}`).textContent = totals[name];
    parties[i].final = totals[name];
  });

  document.getElementById('total-seats').textContent = PARTIES.reduce((s,n)=>s+totals[n],0);
  calculateBtn.style.background = '#008500';

  updateCoalitionFromTotals(totals);
}

resetBtn.addEventListener('click', ()=>{
  parties.forEach((p,i)=>{
    const name = p.name;
    const defaultVal = DEFAULTS[name];
    document.getElementById(`votes-${i}`).value = defaultVal.toFixed(1);
  });
  calculate();
});

document.getElementById('calculate').addEventListener('click', calculate);

// Build table immediately, then run calculation after DOM ready so coalition legend exists
renderTable();
document.addEventListener('DOMContentLoaded', () => { calculate(); });

/* ---------------- Coalition Builder Logic ---------------- */
const COAL_TOTAL = 460;
const COAL_MAJ = 231;
let selected = []; // party names currently in coalition

const legend = document.getElementById("legend");
const overlay = document.getElementById("coalition-overlay");
const counter = document.getElementById("counter");

function toggleParty(name){
  if(selected.includes(name)) selected = selected.filter(n=>n!==name);
  else selected.push(name);
  renderCoalition(lastTotalsCache);
}

let lastTotalsCache = null;
function updateCoalitionFromTotals(totals){
  lastTotalsCache = totals;
  renderCoalition(totals);
}

function renderCoalition(totals){
  if(!totals) return;
  overlay.innerHTML = "";
  legend.innerHTML = "";

  PARTIES.forEach(name => {
    const seats = totals[name]||0;
    const item = document.createElement('div');
    item.className = 'legend-item' + (selected.includes(name) ? ' active' : '');
    item.innerHTML = `<div class="legend-box" style="background:${PARTY_COLORS[name]||'#999'}"></div> <strong>${name}</strong> ${seats}`;
    item.onclick = ()=>toggleParty(name);
    legend.appendChild(item);
  });

  const totalSelected = selected.reduce((s,name)=> s + (totals[name]||0), 0);
  const widthPercent = (totalSelected / COAL_TOTAL) * 100;

  overlay.style.width = "0%";
  overlay.innerHTML = "";
  if(totalSelected > 0){
    selected.forEach(name=>{
      const seats = totals[name]||0;
      const seg = document.createElement('div');
      seg.className = 'segment';
      seg.style.flexBasis = ((seats / totalSelected) * 100) + "%";
      seg.style.background = PARTY_COLORS[name]||"#999";
      seg.title = `${name}: ${seats}`;
      overlay.appendChild(seg);
    });
  }

  requestAnimationFrame(()=>{ overlay.style.width = widthPercent + "%"; });

  counter.textContent = `${totalSelected} / ${COAL_TOTAL}`;
  counter.style.color = totalSelected >= COAL_MAJ ? "#2BA84A" : "#000";

  document.querySelectorAll(".legend-item").forEach(el=>{
    const name = el.querySelector("strong").textContent;
    el.classList.toggle("active", selected.includes(name));
  });
}
</script>

</body>
</html>
